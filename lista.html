<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Lista - Conecta Serviços</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<div class="modal fade" id="modalAvaliacao" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4 text-center">

      <h5>Avaliar Profissional</h5>

      <div id="estrelas" class="mb-3" style="font-size: 30px; cursor:pointer;">
        <span onclick="selecionarNota(1)">☆</span>
        <span onclick="selecionarNota(2)">☆</span>
        <span onclick="selecionarNota(3)">☆</span>
        <span onclick="selecionarNota(4)">☆</span>
        <span onclick="selecionarNota(5)">☆</span>
      </div>

      <button class="btn btn-success" onclick="enviarAvaliacao()">
        Enviar Avaliação
      </button>

    </div>
  </div>
</div>
  
<body>

<nav class="navbar navbar-light bg-light shadow-sm">
  <div class="container-fluid">
    <span class="navbar-brand fw-bold">Conecta Serviços</span>
    <div>
      <span id="usuarioEmail" class="me-3"></span>
      <button class="btn btn-outline-danger btn-sm" onclick="logout()">Sair</button>
    </div>
  </div>
</nav>

<div class="container mt-3">
    <button class="btn btn-secondary" onclick="history.back()">
        ← Voltar
    </button>
</div>
  
<input type="text" id="buscaCategoria"
placeholder="Buscar por categoria"
class="form-control mb-3"
oninput="buscarCategoria()">
  
<div class="container mt-4">
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Categoria</th>
        <th>Telefone</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="tabelaColaboradores"></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>
<script src="auth.js"></script>

<script>
verificarLogin();

<script>
async function carregar() {
    const { data } = await supabaseClient
        .from("colaboradores")
        .select("*")
        .order("id", { ascending: false });

    const tabela = document.getElementById("tabelaColaboradores");
    tabela.innerHTML = "";

    data.forEach(c => {

        const linkWhats = c.whatsapp 
        ? `<a href="https://wa.me/55${c.whatsapp.replace(/\D/g,'')}" target="_blank">WhatsApp</a>`
        : '-';

        tabela.innerHTML += `
        <tr>
            <td>${c.nome}</td>
            <td>${c.categoria}</td>
            <td>${c.endereco || '-'}</td>
            <td>${c.descricao || '-'}</td>
            <td>${linkWhats}</td>
            <td>
⭐ ${c.avaliacao ? c.avaliacao.toFixed(1) : 0}
(${c.total_avaliacoes || 0})
            </td>
        <td>
        <button onclick="abrirModal(${c.id})" class="btn btn-warning btn-sm">
           ⭐ Avaliar
        </button>
    </td>
</tr>
        `;
    });
}
carregar();
  
async function verificarSessao() {
    const { data: { user } } = await supabaseClient.auth.getUser();

    if (!user) {
        window.location.href = "login.html";
        return;
    }

    if (!user.email_confirmed_at) {
        alert("Confirme seu email antes de acessar o sistema.");
        await supabaseClient.auth.signOut();
        window.location.href = "login.html";
    }
}

verificarSessao();
async function excluir(id){
    if(confirm("Deseja excluir?")){
        await supabaseClient.from("colaboradores").delete().eq("id", id);
        carregar();
    }
}

carregar();
</script>

 <script>
async function buscarCategoria() {

    const termo = document.getElementById("buscaCategoria").value;

    const { data } = await supabaseClient
        .from("colaboradores")
        .select("*")
        .ilike("categoria", `%${termo}%`);

    const tabela = document.getElementById("tabelaColaboradores");
    tabela.innerHTML = "";

    data.forEach(c => {

        const linkWhats = c.whatsapp 
        ? `<a href="https://wa.me/55${c.whatsapp.replace(/\D/g,'')}" target="_blank">WhatsApp</a>`
        : '-';

        tabela.innerHTML += `
        <tr>
            <td>${c.nome}</td>
            <td>${c.categoria}</td>
            <td>${c.endereco || '-'}</td>
            <td>${c.descricao || '-'}</td>
            <td>${linkWhats}</td>
            <td>⭐ ${c.avaliacao.toFixed(1)}</td>
        </tr>
        `;
    });
}
</script>

<script>
async function avaliar(colaboradorId){

    const nota = prompt("Dê uma nota de 1 a 5");

    if(!nota || nota < 1 || nota > 5){
        alert("Nota inválida");
        return;
    }

    const { data: { user } } = await supabaseClient.auth.getUser();

    const { error } = await supabaseClient
        .from("avaliacoes")
        .insert([{
            colaborador_id: colaboradorId,
            user_id: user.id,
            nota: nota
        }]);

    if(error){
        alert("Você já avaliou este profissional.");
        return;
    }

    await atualizarMedia(colaboradorId);

    alert("Avaliação enviada!");
    location.reload();
}
</script>

 <script>
async function atualizarMedia(colaboradorId){

    const { data } = await supabaseClient
        .from("avaliacoes")
        .select("nota")
        .eq("colaborador_id", colaboradorId);

    const total = data.length;
    const soma = data.reduce((acc, item) => acc + item.nota, 0);
    const media = soma / total;

    await supabaseClient
        .from("colaboradores")
        .update({
            avaliacao: media,
            total_avaliacoes: total
        })
        .eq("id", colaboradorId);
}
</script>

<script>
let colaboradorSelecionado = null;
let notaSelecionada = 0;
</script>

<script>
function abrirModal(id){
    colaboradorSelecionado = id;
    notaSelecionada = 0;
    atualizarEstrelas();

    const modal = new bootstrap.Modal(document.getElementById('modalAvaliacao'));
    modal.show();
}

function selecionarNota(nota){
    notaSelecionada = nota;
    atualizarEstrelas();
}

function atualizarEstrelas(){
    const estrelas = document.querySelectorAll("#estrelas span");

    estrelas.forEach((e, index) => {
        e.innerText = index < notaSelecionada ? "★" : "☆";
    });
}
</script>

<script>
async function enviarAvaliacao(){

    if(notaSelecionada === 0){
        alert("Escolha uma nota");
        return;
    }

    const { data: { user } } = await supabaseClient.auth.getUser();

    const { error } = await supabaseClient
    .from("avaliacoes")
    .upsert([{
        colaborador_id: colaboradorSelecionado,
        user_id: user.id,
        nota: notaSelecionada
    }], { onConflict: 'colaborador_id,user_id' });

    if(error){
        alert("Você já avaliou este profissional.");
        return;
    }

    await atualizarMedia(colaboradorSelecionado);

    alert("Avaliação enviada!");

    location.reload();
}
</script>

</body>

</html>














