<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Lista - Conecta Serviços</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

<nav class="navbar navbar-light bg-light shadow-sm">
  <div class="container-fluid">
    <span class="navbar-brand fw-bold">Conecta Serviços</span>
    <div>
      <span id="usuarioEmail" class="me-3"></span>

      <a href="minha-conta.html" class="btn btn-outline-primary btn-sm">
         Minha Conta
      </a>
      
      <button class="btn btn-outline-danger btn-sm" onclick="logout()">Sair</button>
    </div>
  </div>
</nav>

<div class="container mt-3">
    <button class="btn btn-secondary" onclick="history.back()">← Voltar</button>
</div>

<div class="container mt-3">
    <select id="filtroCategoria" class="form-select">
        <option value="">Todas as categorias</option>
        <option value="Alimentação">Alimentação</option>
        <option value="Beleza">Beleza</option>
        <option value="Cuidador de Pet's">Cuidador de Pet's</option>
        <option value="Limpeza">Limpeza</option>
        <option value="Mudanças">Mudanças</option>
        <option value="Outros">Outros</option>
        <option value="Pintura Automotiva">Pintura Automotiva</option>
        <option value="Pintura Predial">Pintura Predial</option>
        <option value="Serviços Elétricos">Serviços Elétricos</option>
        <option value="Serviços Gerais">Serviços Gerais</option>
        <option value="Serviços Hidráulicos">Serviços Hidráulicos</option>
        <option value="Tecnologia">Tecnologia</option>
    </select>
</div>

<div class="container mt-4">
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Categoria</th>
        <th>Telefone</th>
        <th>Avaliação</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="tabelaColaboradores"></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>
<script src="auth.js"></script>

<script>
verificarLogin();

async function carregar(){

    const tabela = document.getElementById("tabelaColaboradores");
    tabela.innerHTML = "";

    const categoriaSelecionada = document.getElementById("filtroCategoria").value;

    let query = supabaseClient
        .from("colaboradores")
        .select("*")
        .order("id", { ascending: false });

    if(categoriaSelecionada){
        query = query.eq("categoria", categoriaSelecionada);
    }

    const { data, error } = await query;

    if(error){
        console.log(error);
        return;
    }

    data.forEach(c => {

        tabela.innerHTML += `
        <tr>
            <td>${c.nome}</td>
            <td>${c.categoria}</td>
            <td>${c.telefone || '-'}</td>
            <td>
                ⭐ ${c.avaliacao ? c.avaliacao.toFixed(1) : 0}
                (${c.total_avaliacoes || 0})
            </td>
            <td>
                <button onclick="abrirModal(${c.id})" class="btn btn-warning btn-sm">
                    Avaliar
                </button>
            </td>
        </tr>
        `;
    });
}
</script>

<script>
document.getElementById("filtroCategoria")
.addEventListener("change", carregar);
</script>

<script>
document.addEventListener("DOMContentLoaded", carregar);
</script>

<!-- MODAL -->
<div class="modal fade" id="modalAvaliacao" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4 text-center">
      <h5>Avaliar Profissional</h5>

      <div id="estrelas" class="mb-3" style="font-size: 30px; cursor:pointer;">
        <span onclick="selecionarNota(1)">☆</span>
        <span onclick="selecionarNota(2)">☆</span>
        <span onclick="selecionarNota(3)">☆</span>
        <span onclick="selecionarNota(4)">☆</span>
        <span onclick="selecionarNota(5)">☆</span>
      </div>

      <button class="btn btn-success" onclick="enviarAvaliacao()">
        Enviar Avaliação
      </button>
    </div>
  </div>
</div>

<script>
let colaboradorSelecionado = null;
let notaSelecionada = 0;

function abrirModal(id){
    colaboradorSelecionado = id;
    notaSelecionada = 0;
    atualizarEstrelas();
    new bootstrap.Modal(document.getElementById('modalAvaliacao')).show();
}

function selecionarNota(nota){
    notaSelecionada = nota;
    atualizarEstrelas();
}

function atualizarEstrelas(){
    const estrelas = document.querySelectorAll("#estrelas span");
    estrelas.forEach((e, index) => {
        e.innerText = index < notaSelecionada ? "★" : "☆";
    });
}

async function enviarAvaliacao(){

    if(notaSelecionada === 0){
        alert("Escolha uma nota");
        return;
    }

    const { data: { user } } = await supabaseClient.auth.getUser();

    const { error } = await supabaseClient
    .from("avaliacoes")
    .upsert([{
        colaborador_id: colaboradorSelecionado,
        user_id: user.id,
        nota: notaSelecionada
    }], { onConflict: 'colaborador_id,user_id' });

    if(error){
        alert("Erro ao avaliar");
        return;
    }

    await atualizarMedia(colaboradorSelecionado);

    alert("Avaliação enviada!");
    location.reload();
}

async function atualizarMedia(colaboradorId){

    const { data } = await supabaseClient
        .from("avaliacoes")
        .select("nota")
        .eq("colaborador_id", colaboradorId);

    const total = data.length;
    const soma = data.reduce((acc, item) => acc + item.nota, 0);
    const media = soma / total;

    await supabaseClient
        .from("colaboradores")
        .update({
            avaliacao: media,
            total_avaliacoes: total
        })
        .eq("id", colaboradorId);
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
